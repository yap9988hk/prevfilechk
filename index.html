<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Audit Outcome</title>
<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f8fafc; margin:0; padding:28px; color:#0f172a; }
  .card { max-width:920px; margin:0 auto; background:white; padding:24px; border-radius:12px; box-shadow:0 6px 22px rgba(2,6,23,0.06); }
  h1 { margin:0 0 10px 0; font-size:20px; font-weight:700; }
  label { display:block; margin-top:14px; font-weight:600; }
  textarea, input[type="number"] { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #d1d5db; margin-top:6px; font-size:14px; box-sizing:border-box; }
  button { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; margin-top:16px; font-weight:600; }
  pre { background:#0f172a10; padding:12px; border-radius:8px; margin-top:14px; white-space:pre-wrap; word-break:break-word; }
</style>
</head>
<body>
  <div class="card">
    <h1>Audit Outcome Validation Tools</h1>
    <p style="font-size:13px;color:#475569;">
      Format example: <code>LD-GEN-A1021-1021-E-50-LIFE / EMC-CANCER-A1085-1085-A-1-CANCER- / LD1-FIVE-A1067-1067-A-7.5-LIFE-4</code>
      Format example: <code>LD-GEN-A1022-1022-E-100-LIFE / EMC-CANCER-A1095-1095-A-1-CANCER- / LD1-FIVE-A1068-1068-A-5-LIFE-3</code>
      Format example: <code>LD-GEN-A1023-1032-E-75-LIFE / EMC-CANCER-A1075-1075-A-1-CANCER- / LD1-FIVE-A1069-1069-A-5-LIFE-3</code>
    </p>

    <label><input id="hasCover" type="checkbox" /> Has Existing Cover</label>

    <label>Previous Codes:</label>
    <textarea id="prevCodes" rows="5" placeholder="Enter previous codes, one per line or comma-separated"></textarea>

    <label>Current Codes:</label>
    <textarea id="currCodes" rows="5" placeholder="Enter current codes, one per line or comma-separated"></textarea>

    <label>Days Apart:</label>
    <input id="daysApart" type="number" placeholder="e.g. 500" />

    <button onclick="validate()">Validate</button>

    <pre id="output"></pre>
  </div>

<script>
function parseCodes(input) {
  if (!input) return [];
  return input
    .split(/[\n,]+/)
    .map(s => s.trim())
    .filter(Boolean)
    .map(full => {
      const parts = full.split("-").map(p => p.trim());
      return {
        full,
        type: (parts[0] || "").toUpperCase(),
        family: (parts[3] || "").toUpperCase(),
        amount: Number(parts[5] ?? 0) || 0
      };
    });
}

function sumExactType(codes, exactType) {
  return codes.filter(c => c.type === exactType)
              .reduce((s, c) => s + (isNaN(c.amount) ? 0 : c.amount), 0);
}

function countExactType(codes, exactType) {
  return codes.filter(c => c.type === exactType).length;
}

function missingByType(prev, curr, exactType) {
  return prev
    .filter(p => p.type === exactType)
    .filter(p => !curr.some(c => c.type === exactType && c.family === p.family))
    .map(p => p.full);
}

function reducedLoadCodes(prev, curr) {
  const missing = [];
  prev.filter(p => p.type === "LD").forEach(p => {
    const match = curr.find(c => c.type === "LD" && c.family === p.family);
    if (!match) missing.push(p.full);
    else if (match.amount < p.amount) missing.push(p.full);
  });
  return missing;
}

function validate() {
  const hasCover = document.getElementById("hasCover").checked;
  const prev = parseCodes(document.getElementById("prevCodes").value);
  const curr = parseCodes(document.getElementById("currCodes").value);
  const daysApart = Number(document.getElementById("daysApart").value || 0);

  if (!hasCover) {
    document.getElementById("output").textContent = JSON.stringify(
      { result: "Accepted", codes: { LOAD: [], EMC: [], LOAD1: [] } },
      null, 2
    );
    return;
  }

  const totalPrevLoad = sumExactType(prev, "LD");
  const totalCurrLoad = sumExactType(curr, "LD");
  const loadDiff = totalPrevLoad - totalCurrLoad;

  const prevEMCcount = countExactType(prev, "EMC");
  const currEMCcount = countExactType(curr, "EMC");
  const emcDiff = prevEMCcount - currEMCcount;

  const ld1Missing = missingByType(prev, curr, "LD1");
  const emcMissing = missingByType(prev, curr, "EMC");
  const loadMissing = reducedLoadCodes(prev, curr);

  let result = "Accepted";

  // === Rules ===
  if (loadDiff > 50 && daysApart <= 1095) result = "Decline";                          // Rule #1
  else if (emcDiff > 1 && daysApart <= 1825) result = "Decline";                       // Rule #2
  else if (ld1Missing.length > 0 && daysApart <= 1825) result = "Decline";             // Rule #3
  else if (ld1Missing.length > 0 && daysApart > 1825) result = "ModifiedDeclaration";  // Rule #4
  else if (loadDiff > 50 && daysApart > 1095) result = "ModifiedDeclaration";          // Rule #5
  else if (emcDiff > 1 && daysApart > 1825) result = "ModifiedDeclaration";            // Rule #6
  else if (emcDiff === 1) result = "ModifiedDeclaration";                              // Rule #7
  else if (loadDiff > 0 && loadDiff <= 50) result = "ModifiedDeclaration";             // Rule #8
  else if (loadMissing.length > 0) result = "ModifiedDeclaration";                     // Rule #9
  else if (emcMissing.length > 0) result = "ModifiedDeclaration";                      // Rule #10 (NEW)
  else result = "Accepted";

  const codes = {
    LOAD: loadMissing,
    EMC: emcMissing,
    LOAD1: ld1Missing
  };

  document.getElementById("output").textContent = JSON.stringify({ result, codes }, null, 2);
}
</script>
</body>
</html>
